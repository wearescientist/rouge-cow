# 🐛 肉鸽牛牛 - 自动Bug检测系统

## 概述

AI训练系统 v3.1 新增了**自动Bug检测功能**，让AI在玩游戏的同时也成为游戏测试员，自动发现和记录游戏中的问题。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 训练系统 v3.1                          │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   AI 玩家    │  │  游戏状态    │  │  Bug检测器   │      │
│  │  (最大化分数)│  │  (实时监控)  │  │  (异常检测)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│          │                │                │                │
│          └────────────────┴────────────────┘                │
│                           │                                 │
│                    ┌──────────────┐                        │
│                    │  Bug报告生成 │                        │
│                    │  (JSON+截图) │                        │
│                    └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

## 检测类型

### 🔴 Critical（严重）- 立即处理
| Bug类型 | 说明 | 示例 |
|---------|------|------|
| crash | 游戏崩溃 | 页面无响应、JS异常 |
| logic_error | 逻辑错误 | HP为负数、死亡但胜利 |
| render_error | 渲染错误 | 黑屏、Canvas异常 |

### 🟠 High（高）- 优先处理
| Bug类型 | 说明 | 示例 |
|---------|------|------|
| stuck | 玩家卡死 | 5秒位置无变化 |
| memory_leak | 内存泄漏 | 内存使用>500MB |
| position_error | 位置异常 | 玩家超出房间边界 |
| javascript_error | JS错误 | 控制台报错 |

### 🟡 Medium（中）- 计划处理
| Bug类型 | 说明 | 示例 |
|---------|------|------|
| no_progress | 无进展 | 30秒分数无变化 |
| performance | 性能问题 | FPS<10 |
| anomaly | 状态异常 | 敌人数量>100 |

### 🟢 Low（低）- 可选处理
| Bug类型 | 说明 | 示例 |
|---------|------|------|
| balance | 平衡问题 | 数值异常高 |

## 工作流程

### 1. 训练开始
```
🎮 ===== 牛牛肉鸽 AI 训练 #1 =====
   目标: 最大化游戏分数
   速度: 2x
   🐛 Bug检测系统已启动，将实时监控游戏状态
```

### 2. 实时检测
每10帧（约160ms）检测一次：
- 页面是否响应
- 游戏数值是否异常
- 玩家是否卡死
- 性能是否正常
- 渲染是否正常

### 3. Bug发现
```
🔴 [BUG_001] logic_error
   玩家HP为负数: -5
   
🟠 [BUG_002] stuck
   玩家可能卡死，5.2秒位置无变化
```

### 4. 严重Bug截图
Critical/High级别Bug自动截图保存。

### 5. 训练结束报告
```
🐛 Bug检测报告 - 训练 #1
============================================================
总计: 3 个问题
  🔴 Critical: 1
  🟠 High: 1
  🟡 Medium: 1
  🟢 Low: 0

问题列表:
  - logic_error: 1次
  - stuck: 1次
  - performance: 1次
============================================================
📝 Bug报告已保存: bug_reports/bug_report_1_1234567890.json
```

## Bug报告格式

```json
{
  "trainCount": 1,
  "timestamp": "2026-02-19T12:00:00.000Z",
  "summary": {
    "total": 3,
    "critical": 1,
    "high": 1,
    "medium": 1,
    "low": 0
  },
  "bugs": [
    {
      "bugId": "BUG_001",
      "timestamp": "2026-02-19T12:00:01.000Z",
      "type": "logic_error",
      "severity": "critical",
      "description": "玩家HP为负数: -5",
      "details": { "hp": -5, "maxHp": 6 },
      "screenshot": "bug_reports/BUG_001_1234567890.png"
    }
  ],
  "byType": {
    "logic_error": [...],
    "stuck": [...]
  }
}
```

## 使用指南

### 启动训练（含Bug检测）
```bash
cd archive/ai_training
快速训练.bat
```

### 查看Bug报告
```bash
查看Bug报告.bat
```

功能：
- 显示所有训练的Bug统计
- 按严重程度分类
- 查看问题类型分布
- 打开报告文件夹
- 查看最新报告详情

### 分析Bug报告

#### 1. 查看报告文件
```bash
cd bug_reports
ls bug_report_*.json
```

#### 2. 分析常见问题
```javascript
// 统计最常见的Bug类型
const reports = [...]; // 加载所有报告
const bugTypes = {};
reports.forEach(r => {
  r.bugs.forEach(b => {
    bugTypes[b.type] = (bugTypes[b.type] || 0) + 1;
  });
});
console.log(bugTypes);
```

#### 3. 优先修复建议
1. **Critical**: 影响游戏进行，立即修复
2. **High**: 严重影响体验，本周修复
3. **Medium**: 一般问题，本月修复
4. **Low**: 优化建议，排期修复

## 配置调整

在 `bug_detector.js` 中可以调整检测阈值：

```javascript
this.config = {
  stuckThreshold: 5000,      // 卡死检测时间（毫秒）
  noProgressThreshold: 30000, // 无进度检测时间
  maxHp: 1000,               // 异常HP上限
  maxGold: 99999,            // 异常金币上限
  minFps: 10,                // 最低帧率
  maxMemoryMB: 500,          // 内存上限
};
```

## 如何帮助优化游戏

### 1. 数值平衡问题
如果发现大量 `logic_error`（负数HP、异常金币）：
- 检查伤害计算逻辑
- 检查金币增减逻辑
- 添加数值边界检查

### 2. 地图碰撞问题
如果发现大量 `stuck`（玩家卡死）：
- 检查地图障碍物碰撞盒
- 检查门区域是否被遮挡
- 优化寻路算法

### 3. 性能问题
如果发现 `performance` 或 `memory_leak`：
- 优化绘制循环
- 清理无用对象
- 减少内存分配

### 4. 渲染问题
如果发现 `render_error`：
- 检查Canvas绘制逻辑
- 检查资源加载
- 检查动画循环

## 文件清单

| 文件 | 说明 |
|------|------|
| `bug_detector.js` | Bug检测器核心 |
| `play_game_windows.js` | 集成Bug检测的AI训练 |
| `查看Bug报告.bat` | 查看报告工具 |
| `bug_reports/*.json` | Bug报告文件 |
| `bug_reports/*.png` | Bug截图 |

## 更新日志

### v3.1 (2026-02-19)
- ✅ 新增自动Bug检测系统
- ✅ 7大类Bug检测
- ✅ 4级严重程度分类
- ✅ 自动截图功能
- ✅ Bug统计报告
- ✅ 查看报告工具
