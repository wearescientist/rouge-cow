# v0.7.1 设计文档 - 盲眼NPC商店系统 + 穿墙修复

## 1. 功能概述

### 1.1 盲眼NPC商店系统
根据故事大纲，盲眼是一只老迈的鼹鼠，住在墙壁上的隔离腔室里。在游戏中，商店房将显示盲眼NPC形象，玩家可以与其交互购买道具。

### 1.2 穿墙问题修复
当前玩家可以通过门走出地图边界，需要添加边界检测防止玩家走出房间。

## 2. 设计方案

### 2.1 盲眼NPC设计

**外观描述**（来自故事大纲）：
- 老迈的鼹鼠
- 住在墙壁上的隔离腔室
- 周围涂满抑制菌丝生长的分泌物

**游戏表现**：
- 使用emoji 🦯👁️（盲眼形象）
- 位于商店房左侧墙壁
- 玩家靠近时显示交互提示

### 2.2 商店系统

**交互方式**：
- 玩家靠近NPC（距离<60）按E键打开商店
- 商店界面显示3个可购买道具
- 使用金币作为货币

**商品生成**：
- 每次进入商店房生成3个随机道具
- 道具价格 = 基础价格 + 随机波动
- 稀有度越高价格越贵

**价格体系**：
| 稀有度 | 基础价格 |
|--------|----------|
| common | 30-50 |
| rare | 60-100 |
| epic | 120-200 |

### 2.3 穿墙修复

**问题分析**：
- 玩家可以通过门走出地图
- 房间边界检测不完整

**修复方案**：
- 添加房间硬边界检测（墙壁区域不可进入）
- 门区域只有在清理房间后才能通过
- 玩家位置限制在有效游戏区域内

## 3. 代码修改计划

### 3.1 新增ShopNPC类
```javascript
class ShopNPC {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.name = '盲眼';
        this.dialogues = [...]; // 随机对话
    }
    draw(ctx) { ... }
    getDialogue() { ... }
}
```

### 3.2 商店UI
```javascript
// 商店界面状态
this.shopOpen = false;
this.shopItems = []; // 当前商店商品

// 打开/关闭商店
openShop() { ... }
closeShop() { ... }
// 购买道具
buyItem(index) { ... }
```

### 3.3 边界修复
```javascript
// 在update中添加边界检测
// 门区域检测
// 墙壁碰撞检测
```

## 4. 与故事大纲的契合

- 盲眼NPC形象符合故事中的描述
- 商店系统为玩家提供成长途径
- 金币系统增加游戏策略性

## 5. 测试计划

1. 进入商店房，确认盲眼NPC显示正常
2. 靠近NPC按E打开商店
3. 尝试购买道具，确认金币扣除正确
4. 测试边界，确认无法穿墙
5. 录制测试视频
