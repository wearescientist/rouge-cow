// è‚‰é¸½ç‰›ç‰› v3.0 FINAL - Complete Edition
// æ•´åˆæ‰€æœ‰ä¼˜åŒ–ï¼Œä¿®å¤æ‰€æœ‰å·²çŸ¥Bug

const Utils={distance:(a,b)=>Math.hypot(a.x-b.x,a.y-b.y),clamp:(v,min,max)=>Math.max(min,Math.min(max,v))};
const CONFIG={VERSION:'3.0.0',MAX_PARTICLES:150,MAX_ENEMIES:35,TILE_SIZE:80};

// ========== å­˜å‚¨ç³»ç»Ÿ (å¸¦æ•°æ®è¿ç§») ==========
const SaveSystem={
    KEY:'rogueCow_v30',
    VERSION:3,
    load(){
        const raw=localStorage.getItem(this.KEY);
        if(raw){const d=JSON.parse(raw);if(d.VERSION===this.VERSION)return d}
        const migrated=this.migrate();
        return migrated||{VERSION:this.VERSION,gold:0,totalKills:0,totalRuns:0,bestTime:0,bestWave:0,permanent:{damage:0,hp:0,speed:0,expGain:0,critChance:0,armor:0},achievements:{},stats:{totalDamage:0,totalExp:0,bossesKilled:0,powerupsUsed:0},dailyCompleted:false,lastDaily:null,settings:{volume:0.3,showMinimap:true,particles:true}}
    },
    migrate(){
        for(let v=29;v>=20;v--){const old=localStorage.getItem(`rogueCow_v${v}`);if(old){const d=JSON.parse(old);d.VERSION=this.VERSION;localStorage.setItem(this.KEY,JSON.stringify(d));console.log(`Migrated from v${v}`);return d}}
        return null
    },
    save(d){d.VERSION=this.VERSION;localStorage.setItem(this.KEY,JSON.stringify(d))},
    unlock(id){const s=this.load();if(!s.achievements[id]){s.achievements[id]=Date.now();this.save(s);return true}return false}
};

// ========== åœ°å›¾ç³»ç»Ÿ (ä¿®å¤è¾¹ç•Œé—®é¢˜) ==========
class MapSystem{
    constructor(W,H){this.W=W;this.H=H;this.cols=Math.ceil(W/CONFIG.TILE_SIZE);this.rows=Math.ceil(H/CONFIG.TILE_SIZE);this.tiles=[];this.rooms=[];this.generate()}
    generate(){
        for(let y=0;y<this.rows;y++){this.tiles[y]=[];for(let x=0;x<this.cols;x++)this.tiles[y][x]=1}
        this.rooms=[];
        for(let i=0;i<8;i++){const w=5+Math.floor(Math.random()*7);const h=5+Math.floor(Math.random()*7);const x=2+Math.floor(Math.random()*(this.cols-w-4));const y=2+Math.floor(Math.random()*(this.rows-h-4));let overlap=false;for(let r of this.rooms)if(x<r.x+r.w+2&&x+w+2>r.x&&y<r.y+r.h+2&&y+h+2>r.y){overlap=true;break}if(!overlap){this.rooms.push({x,y,w,h,cx:Math.floor(x+w/2),cy:Math.floor(y+h/2)});for(let ry=y;ry<y+h;ry++)for(let rx=x;rx<x+w;rx++)this.tiles[ry][rx]=0}}
        if(this.rooms.length<3)return this.generate();
        for(let i=0;i<this.rooms.length-1;i++){const r1=this.rooms[i],r2=this.rooms[i+1];let x=r1.cx,y=r1.cy;while(x!==r2.cx){this.tiles[y][x]=0;x+=x<r2.cx?1:-1}while(y!==r2.cy){this.tiles[y][x]=0;y+=y<r2.cy?1:-1}}
        this.startRoom=this.rooms[0];this.bossRoom=this.rooms[this.rooms.length-1]
    }
    isWall(x,y){const tx=Math.floor(x/CONFIG.TILE_SIZE),ty=Math.floor(y/CONFIG.TILE_SIZE);if(tx<0||tx>=this.cols||ty<0||ty>=this.rows)return true;return this.tiles[ty][tx]===1}
    draw(ctx,camX,camY){const sc=Math.floor(camX/CONFIG.TILE_SIZE),ec=sc+Math.ceil(ctx.canvas.width/CONFIG.TILE_SIZE)+1;const sr=Math.floor(camY/CONFIG.TILE_SIZE),er=sr+Math.ceil(ctx.canvas.height/CONFIG.TILE_SIZE)+1;ctx.strokeStyle='#3d2b3e';ctx.lineWidth=2;for(let y=Math.max(0,sr);y<Math.min(this.rows,er);y++)for(let x=Math.max(0,sc);x<Math.min(this.cols,ec);x++)if(this.tiles[y][x]===1){ctx.fillStyle='#1a0f1a';ctx.fillRect(x*CONFIG.TILE_SIZE,y*CONFIG.TILE_SIZE,CONFIG.TILE_SIZE,CONFIG.TILE_SIZE);ctx.strokeRect(x*CONFIG.TILE_SIZE,y*CONFIG.TILE_SIZE,CONFIG.TILE_SIZE,CONFIG.TILE_SIZE)}}
    drawMinimap(ctx,px,py,explored,current,show){if(!show)return;const ms=100,mx=ctx.canvas.width-ms-15,my=15,scale=ms/Math.max(this.cols,this.rows);ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(mx,my,ms,ms);ctx.strokeStyle='#555';ctx.strokeRect(mx,my,ms,ms);for(let r of this.rooms){if(!explored.has(this.rooms.indexOf(r)))continue;ctx.fillStyle=r===this.rooms[current]?'#3498DB':r===this.bossRoom?'#E74C3C':'rgba(100,100,100,0.5)';ctx.fillRect(mx+r.x*scale,my+r.y*scale,r.w*scale,r.h*scale)}ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(mx+(px/CONFIG.TILE_SIZE)*scale,my+(py/CONFIG.TILE_SIZE)*scale,2.5,0,Math.PI*2);ctx.fill()}
}

// ========== æ•°æ® ==========
const ACHIEVEMENTS={first_blood:{n:'ç¬¬ä¸€æ»´è¡€',d:'å‡»æ€ç¬¬ä¸€ä¸ªæ•Œäºº',i:'ğŸ©¸'},survivor:{n:'å¹¸å­˜è€…',d:'å­˜æ´»5åˆ†é’Ÿ',i:'â±ï¸'},wave_10:{n:'æ³¢æ¬¡å¤§å¸ˆ',d:'è¾¾åˆ°ç¬¬10æ³¢',i:'ğŸŒŠ'},boss_slayer:{n:'BOSSæ€æ‰‹',d:'å‡»è´¥BOSS',i:'ğŸ‘‘'},explorer:{n:'æ¢ç´¢è€…',d:'è¿›å…¥æ‰€æœ‰æˆ¿é—´',i:'ğŸ—ºï¸'},rich:{n:'å¯Œè±ª',d:'å•å±€1000é‡‘å¸',i:'ğŸ’°'},level_20:{n:'æ»¡çº§å¤§ä½¬',d:'è¾¾åˆ°20çº§',i:'â­'},killer_100:{n:'ç™¾äººæ–©',d:'ç´¯è®¡å‡»æ€100',i:'ğŸ’€'},killer_1000:{n:'åƒäººæ–©',d:'ç´¯è®¡å‡»æ€1000',i:'â˜ ï¸'},collector:{n:'æ”¶è—å®¶',d:'è§£é”æ‰€æœ‰æ­¦å™¨',i:'ğŸ”«'}};
const POWERUPS={health:{c:'#E74C3C',i:'â¤ï¸',e:p=>p.hp=Math.min(p.mhp+2,p.hp+5)},speed:{c:'#3498DB',i:'âš¡',e:p=>{p.sp*=1.5;setTimeout(()=>p.sp/=1.5,5e3)}},damage:{c:'#E67E22',i:'ğŸ’ª',e:p=>{p.dmg*=2;setTimeout(()=>p.dmg/=2,5e3)}},magnet:{c:'#9B59B6',i:'ğŸ§²',e:p=>{p.magnet=300;setTimeout(()=>p.magnet=0,8e3)}},shield:{c:'#F1C40F',i:'ğŸ›¡ï¸',e:p=>{p.shield=true;setTimeout(()=>p.shield=false,5e3)}},bomb:{c:'#C0392B',i:'ğŸ’£',e:(p,e,ps)=>{e.forEach(en=>{en.hp-=10;ps.explode(en.x,en.y,'#C0392B',3)})}}};

// ========== éŸ³é¢‘ç³»ç»Ÿ (ä¿®å¤è‡ªåŠ¨æ’­æ”¾é—®é¢˜) ==========
const Audio={
    ctx:null,_vol:0.3,_init:false,
    get vol(){return this._vol},
    set vol(v){this._vol=v;const s=SaveSystem.load();s.settings.volume=v;SaveSystem.save(s)},
    init(){if(this._init)return;this._init=true;try{window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new AudioContext();if(this.ctx.state==='suspended'){const r=()=>{this.ctx.resume();document.removeEventListener('click',r);document.removeEventListener('keydown',r)};document.addEventListener('click',r);document.addEventListener('keydown',r)}}catch(e){console.warn('Audio not supported')}},
    resume(){this.ctx?.state==='suspended'&&this.ctx.resume()},
    play(f,d,t='square',v=0.1){if(!this.ctx)return;this.resume();try{const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.value=f;o.type=t;g.gain.setValueAtTime(v*this.vol,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+d);o.start();o.stop(this.ctx.currentTime+d)}catch(e){}},
    shoot(){this.play(440,0.1)},hit(){this.play(200,0.15,'sawtooth')},explode(){this.play(150,0.3,'sawtooth')},level(){this.play(523,0.2);setTimeout(()=>this.play(659,0.2),100);setTimeout(()=>this.play(784,0.4),200)},click(){this.play(880,0.05)},boss(){this.play(150,0.3);setTimeout(()=>this.play(100,0.4),300)},power(){this.play(600,0.1);setTimeout(()=>this.play(800,0.15),100)},achieve(){this.play(523,0.1);setTimeout(()=>this.play(659,0.1),100);setTimeout(()=>this.play(784,0.1),200);setTimeout(()=>this.play(1047,0.3),300)}
};

// ========== ç²’å­ç³»ç»Ÿ ==========
class Particles{constructor(){this.pool=[];this.nums=[];this.shake=0;for(let i=0;i<CONFIG.MAX_PARTICLES;i++)this.pool.push({a:false})}explode(x,y,c='#FFF',n=10,f=4){let cnt=0;for(let p of this.pool)if(!p.a){p.a=true;p.x=x;p.y=y;const ang=(Math.PI*2*cnt)/n;p.vx=Math.cos(ang)*f;p.vy=Math.sin(ang)*f;p.life=30;p.c=c;p.s=4;cnt++;if(cnt>=n)break}this.shake=8}hit(x,y){for(let i=0;i<4;i++){const p=this.pool.find(p=>!p.a);if(p){p.a=true;p.x=x;p.y=y;p.vx=(Math.random()-0.5)*5;p.vy=(Math.random()-0.5)*5;p.life=15;p.c='#FFF';p.s=2}}}damage(x,y,d,crit){if(this.nums.length>20)this.nums.shift();this.nums.push({x,y,t:crit?`CRIT ${~~d}!`:~~d,l:35,vy:-1.5,c:crit?'#FFD700':'#FFF',s:crit?20:14})}shakeScreen(ctx){if(this.shake>0){const dx=(Math.random()-0.5)*this.shake,dy=(Math.random()-0.5)*this.shake;ctx.translate(dx,dy);this.shake*=0.9;if(this.shake<0.5)this.shake=0;return()=>ctx.translate(-dx,-dy)}return null}update(){for(let p of this.pool)if(p.a){p.x+=p.vx;p.y+=p.vy;p.life--;p.s*=0.96;if(p.life<=0)p.a=false}for(let i=this.nums.length-1;i>=0;i--){const d=this.nums[i];d.y+=d.vy;d.l--;if(d.l<=0)this.nums.splice(i,1)}}draw(ctx){const s=SaveSystem.load();if(!s.settings.particles){for(let d of this.nums){ctx.globalAlpha=d.l/35;ctx.fillStyle=d.c;ctx.font=`bold ${d.s}px monospace`;ctx.textAlign='center';ctx.fillText(d.t,d.x,d.y)}ctx.textAlign='left';ctx.globalAlpha=1;return}for(let p of this.pool)if(p.a){ctx.globalAlpha=p.life/30;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.s,0,Math.PI*2);ctx.fill()}ctx.globalAlpha=1;for(let d of this.nums){ctx.globalAlpha=d.l/35;ctx.fillStyle=d.c;ctx.font=`bold ${d.s}px monospace`;ctx.textAlign='center';ctx.fillText(d.t,d.x,d.y)}ctx.textAlign='left';ctx.globalAlpha=1}}

// ========== æ¸¸æˆå®ä½“ ==========
class Entity{constructor(x,y,s,c){this.x=x;this.y=y;this.s=s;this.c=c;this.active=true}}
class Powerup extends Entity{constructor(x,y,t){const p=POWERUPS[t];super(x,y,28,p.c);this.t=t;this.i=p.i;this.bob=Math.random()*Math.PI*2}update(){this.bob+=0.08}draw(ctx){const b=Math.sin(this.bob)*4;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y+b,this.s/2,0,Math.PI*2);ctx.fill();ctx.fillStyle='#FFF';ctx.font='18px monospace';ctx.textAlign='center';ctx.fillText(this.i,this.x,this.y+b+6);ctx.textAlign='left'}}
class Boss extends Entity{constructor(x,y){super(x,y,85,'#8E44AD');this.mhp=80;this.hp=this.mhp;this.sp=1.3;this.ph=1;this.at=0;this.mt=0;this.tx=x;this.ty=y;this.f=-1}update(p,map){this.at++;this.mt++;if(this.hp<this.mhp*0.5)this.ph=2;if(this.hp<this.mhp*0.25)this.ph=3;if(this.mt%90===0){let attempts=0;do{const a=Math.random()*Math.PI*2,d=100+Math.random()*60;this.tx=Utils.clamp(this.x+Math.cos(a)*d,this.s+10,map.W-this.s-10);this.ty=Utils.clamp(this.y+Math.sin(a)*d,this.s+10,map.H-this.s-10);attempts++}while(map.isWall(this.tx,this.ty)&&attempts<10)}const dx=this.tx-this.x,dy=this.ty-this.y,d=Math.hypot(dx,dy);if(d>4){const nx=(dx/d)*this.sp,ny=(dy/d)*this.sp;if(!map.isWall(this.x+nx,this.y))this.x+=nx;if(!map.isWall(this.x,this.y+ny))this.y+=ny}const pdx=p.x-this.x;this.f=pdx<0?-1:pdx>0?1:this.f}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.f===1)ctx.scale(-1,1);const pu=1+Math.sin(Date.now()/200)*0.08;ctx.fillStyle=this.ph===3?'#C0392B':this.ph===2?'#E74C3C':'#8E44AD';ctx.beginPath();ctx.arc(0,0,this.s/2*pu,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(-10,-10,8,0,Math.PI*2);ctx.arc(10,-10,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#E74C3C';ctx.beginPath();ctx.arc(-10+Math.sin(Date.now()/100),-10,4,0,Math.PI*2);ctx.arc(10+Math.sin(Date.now()/100),-10,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-this.s/2,-this.s/2-10,this.s,6);ctx.fillStyle=this.ph===3?'#C0392B':'#E74C3C';ctx.fillRect(-this.s/2+1,-this.s/2-8,(this.s-2)*(this.hp/this.mhp),4);ctx.fillStyle='#FFF';ctx.font='bold 14px monospace';ctx.textAlign='center';ctx.fillText(`BOSS ${~~this.hp}`,0,-this.s/2-12);ctx.restore()}}
class Enemy extends Entity{constructor(x,y,t='pig'){const types={chick:{c:'#FFD700',hp:1,sp:2.3,exp:8,s:32,g:1},pig:{c:'#FF69B4',hp:3,sp:1.3,exp:12,s:42,g:2},sheep:{c:'#ECF0F1',hp:5,sp:1,exp:15,s:48,g:3},cow:{c:'#FFF',hp:8,sp:0.8,exp:20,s:52,g:5},bull:{c:'#C0392B',hp:12,sp:1.6,exp:30,s:55,g:8},fox:{c:'#E67E22',hp:4,sp:2,exp:18,s:38,g:4}};const tp=types[t]||types.pig;super(x,y,tp.s,tp.c);this.t=t;this.hp=tp.hp;this.mhp=tp.hp;this.sp=tp.sp;this.exp=tp.exp;this.g=tp.g;this.f=-1}update(p,map){const dx=p.x-this.x,dy=p.y-this.y,d=Math.hypot(dx,dy);if(d>0){const nx=(dx/d)*this.sp,ny=(dy/d)*this.sp;if(!map.isWall(this.x+nx,this.y))this.x+=nx;if(!map.isWall(this.x,this.y+ny))this.y+=ny}this.f=dx<0?-1:dx>0?1:this.f}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.f===1)ctx.scale(-1,1);ctx.fillStyle=this.c;ctx.fillRect(-this.s/2,-this.s/2,this.s,this.s);ctx.fillStyle='#000';ctx.fillRect(-this.s/3,-this.s/4,this.s/6,this.s/6);ctx.fillRect(this.s/6,-this.s/4,this.s/6,this.s/6);if(this.hp<this.mhp){ctx.fillStyle='#000';ctx.fillRect(-this.s/2,-this.s/2-7,this.s,4);ctx.fillStyle='#E74C3C';ctx.fillRect(-this.s/2,-this.s/2-7,this.s*(this.hp/this.mhp),4)}ctx.restore()}}
class Bullet extends Entity{constructor(x,y,tx,ty,dmg,crit,sp=10){super(x,y,7,crit?'#FFD700':'#FFF');this.dmg=dmg;this.crit=crit;const a=Math.atan2(ty-y,tx-x);this.vx=Math.cos(a)*sp;this.vy=Math.sin(a)*sp}update(W,H){this.x+=this.vx;this.y+=this.vy;if(this.x<-50||this.x>W+50||this.y<-50||this.y>H+50)this.active=false}draw(ctx){ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,this.crit?6:4,0,Math.PI*2);ctx.fill();if(this.crit){ctx.strokeStyle='#FFD700';ctx.lineWidth=2;ctx.stroke()}}}
class Player extends Entity{constructor(x,y,perm={},w='single'){super(x,y,32,'#FFF');this.mhp=3+perm.hp;this.hp=this.mhp;this.bsp=5+perm.speed*0.3;this.sp=this.bsp;this.bdmg=1+perm.damage*0.5;this.dmg=this.bdmg;this.lvl=1;this.exp=0;this.expReq=100;this.cd=0;this.inv=0;this.f=1;this.crit=perm.critChance*0.05;this.arm=perm.armor*0.5;this.expMul=1+perm.expGain*0.1;this.w=w;this.magnet=0;this.shield=false}update(inpt,en,map){let dx=0,dy=0;if(inpt.keys.w||inpt.keys.arrowup)dy=-1;if(inpt.keys.s||inpt.keys.arrowdown)dy=1;if(inpt.keys.a||inpt.keys.arrowleft){dx=-1;this.f=-1}if(inpt.keys.d||inpt.keys.arrowright){dx=1;this.f=1}if(dx!==0||dy!==0){const l=Math.hypot(dx,dy);const nx=(dx/l)*this.sp,ny=(dy/l)*this.sp;if(!map.isWall(this.x+nx,this.y))this.x+=nx;if(!map.isWall(this.x,this.y+ny))this.y+=ny}this.x=Utils.clamp(this.x,this.s/2+5,map.W-this.s/2-5);this.y=Utils.clamp(this.y,this.s/2+5,map.H-this.s/2-5);if(this.inv>0)this.inv--;if(this.cd>0)this.cd--;if(this.cd<=0)return this.findTarget(en);return null}findTarget(en){let near=null,minD=260;for(let e of en){const d=Utils.distance(this,e);if(d<minD){minD=d;near=e}}return near}shoot(t,bs){if(!t)return;const crit=Math.random()<this.crit;const cds={single:16,dual:12,shotgun:28,spread:20,rapid:6,laser:32};switch(this.w){case'single':bs.push(new Bullet(this.x,this.y,t.x,t.y,this.dmg,crit));break;case'dual':bs.push(new Bullet(this.x-7,this.y,t.x,t.y,this.dmg*0.8,crit));bs.push(new Bullet(this.x+7,this.y,t.x,t.y,this.dmg*0.8,crit));break;case'shotgun':for(let i=-2;i<=2;i++){const a=Math.atan2(t.y-this.y,t.x-this.x)+i*0.2;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.6,crit))}break;case'spread':for(let i=0;i<6;i++){const a=(Math.PI*2*i)/6;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.55,crit))}break;case'rapid':const sp=(Math.random()-0.5)*0.3,a=Math.atan2(t.y-this.y,t.x-this.x)+sp;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.7,crit,12));break;case'laser':bs.push(new Bullet(this.x,this.y,t.x,t.y,this.dmg*2.2,crit,15))}this.cd=cds[this.w]||16;Audio.shoot()}gainExp(a,ps){const fa=a*this.expMul;this.exp+=fa;if(this.exp>=this.expReq){this.exp-=this.expReq;this.lvl++;this.expReq=~~(this.expReq*1.2);this.hp=Math.min(this.mhp+1,this.hp+1);Audio.level();if(ps)ps.explode(this.x,this.y,'#FFD700',15);return true}return false}takeDamage(dmg){if(this.shield||this.inv>0)return false;const ad=Math.max(1,dmg-this.arm);this.hp-=ad;this.inv=45;Audio.hit();return this.hp<=0}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.inv>0&&~~(Date.now()/40)%2)ctx.globalAlpha=0.5;if(this.f===-1)ctx.scale(-1,1);if(this.shield){ctx.strokeStyle='#F1C40F';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,28,0,Math.PI*2);ctx.stroke()}ctx.fillStyle='#FFE4C4';ctx.fillRect(-16,-24,32,48);ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(0,-20,16,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-6,-22,2,2);ctx.fillRect(4,-22,2,2);ctx.restore()}}

// ========== æ¸¸æˆä¸»ç±» (ä¿®å¤æ‰€æœ‰å·²çŸ¥Bug) ==========
class Game{constructor(w='single',daily=false){this.cv=document.getElementById('gameCanvas');this.cx=this.cv.getContext('2d');this.resize();window.addEventListener('resize',()=>this.resize());this.save=SaveSystem.load();Audio.vol=this.save.settings.volume;this.map=new MapSystem(this.cv.width,this.cv.height);const sr=this.map.startRoom;this.p=new Player(sr.cx*CONFIG.TILE_SIZE+CONFIG.TILE_SIZE/2,sr.cy*CONFIG.TILE_SIZE+CONFIG.TILE_SIZE/2,this.save.permanent,w);this.en=[];this.bs=[];this.ps=new Particles();this.pups=[];this.wave=1;this.wt=0;this.gt=0;this.kills=0;this.gold=0;this.boss=null;this.over=false;this.paused=false;this.upgrading=false;this.upgs=[];this.daily=daily;this.run={dmg:0,exp:0,boss:0,pup:0};this.newAch=[];this.achPop=null;this.explored=new Set();this.currentRoom=this.getRoomAt(this.p.x,this.p.y);this.explored.add(this.currentRoom);this.camera={x:0,y:0};this.inp={keys:{}};window.addEventListener('keydown',e=>{this.inp.keys[e.key.toLowerCase()]=true;if(e.key==='Escape')this.togglePause();if(e.key>='1'&&e.key<='3'&&this.upgrading)this.pickUpg(parseInt(e.key)-1);if(e.key==='m'||e.key==='M'){this.save.settings.showMinimap=!this.save.settings.showMinimap;SaveSystem.save(this.save)}if(e.key==='p'||e.key==='P'){this.save.settings.particles=!this.save.settings.particles;SaveSystem.save(this.save)}});window.addEventListener('keyup',e=>this.inp.keys[e.key.toLowerCase()]=false);this.loop=this.loop.bind(this);Audio.init()}resize(){this.cv.width=window.innerWidth;this.cv.height=window.innerHeight;this.map&&this.map.generate();if(this.p){this.p.x=Utils.clamp(this.p.x,this.p.s/2,this.map.W-this.p.s/2);this.p.y=Utils.clamp(this.p.y,this.p.s/2,this.map.H-this.p.s/2)}}togglePause(){if(!this.over&&!this.upgrading)this.paused=!this.paused}getRoomAt(x,y){const tx=Math.floor(x/CONFIG.TILE_SIZE),ty=Math.floor(y/CONFIG.TILE_SIZE);for(let i=0;i<this.map.rooms.length;i++){const r=this.map.rooms[i];if(tx>=r.x&&tx<r.x+r.w&&ty>=r.y&&ty<r.y+r.h)return i}return -1}
    updateCamera(){const tx=this.p.x-this.cv.width/2,ty=this.p.y-this.cv.height/2;this.camera.x+=Math.max(-15,Math.min(15,(tx-this.camera.x)*0.08));this.camera.y+=Math.max(-15,Math.min(15,(ty-this.camera.y)*0.08));this.camera.x=Utils.clamp(this.camera.x,0,this.map.W-this.cv.width);this.camera.y=Utils.clamp(this.camera.y,0,this.map.H-this.cv.height)}
    checkAch(){const checks=[{id:'first_blood',c:this.kills>=1},{id:'survivor',c:this.gt>=300},{id:'wave_10',c:this.wave>=10},{id:'boss_slayer',c:this.run.boss>=1},{id:'explorer',c:this.explored.size>=this.map.rooms.length},{id:'rich',c:this.gold>=1000},{id:'level_20',c:this.p.lvl>=20},{id:'killer_100',c:this.save.totalKills+this.kills>=100},{id:'killer_1000',c:this.save.totalKills+this.kills>=1000},{id:'collector',c:this.save.gold>=2000}];checks.forEach(ch=>{if(ch.c&&SaveSystem.unlock(ch.id)){this.newAch.push(ACHIEVEMENTS[ch.id]);this.achPop||setTimeout(()=>{if(this.newAch.length>0){this.achPop={a:this.newAch.shift(),t:180};Audio.achieve()}},100)}})}
    spawnEn(){if(this.en.length>=CONFIG.MAX_ENEMIES)return;const roomIdx=Math.floor(Math.random()*this.map.rooms.length);const r=this.map.rooms[roomIdx];const x=(r.x+1+Math.random()*(r.w-2))*CONFIG.TILE_SIZE;const y=(r.y+1+Math.random()*(r.h-2))*CONFIG.TILE_SIZE;const types=['chick','pig'];if(this.wave>2)types.push('sheep');if(this.wave>4)types.push('cow','fox');if(this.wave>6)types.push('bull');this.en.push(new Enemy(x,y,types[~~(Math.random()*types.length)]))}spawnPup(x,y){if(Math.random()>0.1)return;this.pups.push(new Powerup(x,y,Object.keys(POWERUPS)[~~(Math.random()*6)]))}spawnBoss(){const br=this.map.bossRoom;this.boss=new Boss(br.cx*CONFIG.TILE_SIZE+CONFIG.TILE_SIZE/2,br.cy*CONFIG.TILE_SIZE+CONFIG.TILE_SIZE/2);Audio.boss()}pickUpg(i){if(i>=0&&i<this.upgs.length){this.upgs[i].a();this.upgrading=false;this.upgs=[];Audio.level()}}genUpgs(){const all=[{n:'ä¼¤å®³+0.5',a:()=>this.p.dmg+=0.5},{n:'ç”Ÿå‘½+1',a:()=>{this.p.mhp++;this.p.hp++}},{n:'ç§»é€Ÿ+0.5',a:()=>this.p.sp+=0.5},{n:'æš´å‡»+5%',a:()=>this.p.crit+=0.05},{n:'æŠ¤ç”²+0.5',a:()=>this.p.arm+=0.5},{n:'ç»éªŒ+10%',a:()=>this.p.expMul+=0.1}];return all.sort(()=>0.5-Math.random()).slice(0,3)}
    update(){if(this.paused||this.over||this.upgrading){if(this.achPop&&this.achPop.t>0)this.achPop.t--;return}this.updateCamera();this.gt+=1/60;this.wt++;this.checkAch();const newRoom=this.getRoomAt(this.p.x,this.p.y);if(newRoom!==-1&&newRoom!==this.currentRoom){this.currentRoom=newRoom;this.explored.add(newRoom)}if(this.achPop){this.achPop.t--;if(this.achPop.t<=0)this.achPop=null}const sr=this.boss?45:Math.max(20,90-this.wave*3);if(this.wt%sr===0)this.spawnEn();if(!this.boss&&this.wave%5===0&&this.wt===450)this.spawnBoss();if(!this.boss&&this.wt%1200===0)this.wave++;const targets=this.boss?[this.boss,...this.en]:this.en;const t=this.p.update(this.inp,targets,this.map);if(t)this.p.shoot(t,this.bs);for(let p of this.pups)p.update();for(let i=this.pups.length-1;i>=0;i--){const p=this.pups[i],d=Utils.distance(this.p,p);if(d<this.p.s/2+p.s/2||(this.p.magnet>0&&d<this.p.magnet)){POWERUPS[p.t].e(this.p,this.en,this.ps);if(p.t==='bomb'){const killed=this.en.filter(e=>e.hp<=0);killed.forEach(e=>{this.p.gainExp(e.exp,this.ps);this.gold+=e.g;this.kills++});this.en=this.en.filter(e=>e.hp>0)}this.run.pup++;Audio.power();this.pups.splice(i,1)}}for(let i=this.bs.length-1;i>=0;i--){const b=this.bs[i];b.update(this.map.W,this.map.H);if(!b.active){this.bs.splice(i,1);continue}if(this.boss&&Utils.distance(b,this.boss)<this.boss.s/2+8){b.active=false;this.boss.hp-=b.dmg;this.run.dmg+=b.dmg;this.ps.damage(this.boss.x,this.boss.y-40,b.dmg,b.crit);if(this.boss.hp<=0){this.ps.explode(this.boss.x,this.boss.y,'#8E44AD',35,6);this.p.gainExp(200,this.ps);this.gold+=50;this.spawnPup(this.boss.x,this.boss.y);this.run.boss++;this.run.exp+=200;this.boss=null;this.wave++;Audio.explode()}}for(let j=this.en.length-1;j>=0;j--){const e=this.en[j];if(Utils.distance(b,e)<e.s/2+8){b.active=false;e.hp-=b.dmg;this.run.dmg+=b.dmg;this.ps.damage(e.x,e.y-15,b.dmg,b.crit);this.ps.hit(e.x,e.y);if(e.hp<=0){this.en.splice(j,1);const lv=this.p.gainExp(e.exp,this.ps);this.run.exp+=e.exp;this.gold+=e.g;this.spawnPup(e.x,e.y);this.ps.explode(e.x,e.y,e.c,7);Audio.explode();this.kills++;if(lv){this.upgrading=true;this.upgs=this.genUpgs()}}break}}}if(this.boss){this.boss.update(this.p,this.map);if(Utils.distance(this.boss,this.p)<this.boss.s/2+22)if(this.p.takeDamage(2))return this.end()}for(let i=this.en.length-1;i>=0;i--){const e=this.en[i];e.update(this.p,this.map);if(Utils.distance(e,this.p)<e.s/2+16)if(this.p.takeDamage(1))return this.end()}this.ps.update()}draw(){this.cx.save();this.cx.translate(-this.camera.x,-this.camera.y);const sr=this.ps.shakeScreen(this.cx);this.cx.fillStyle='#2d1b2e';this.cx.fillRect(this.camera.x,this.camera.y,this.cv.width,this.cv.height);this.map.draw(this.cx,this.camera.x,this.camera.y);this.ps.draw(this.cx);for(let p of this.pups)p.draw(this.cx);for(let b of this.bs)b.draw(this.cx);if(this.boss)this.boss.draw(this.cx);for(let e of this.en)e.draw(this.cx);this.p.draw(this.cx);if(sr)sr();this.cx.restore();this.drawUI()}drawUI(){const c=this.cx;c.fillStyle='#FFF';c.font='14px monospace';c.textAlign='left';let y=25;c.fillText(`HP:${'â¤ï¸'.repeat(Math.max(0,this.p.hp))}${'ğŸ–¤'.repeat(Math.max(0,this.p.mhp-this.p.hp))}`,12,y);y+=20;c.fillText(`Lv:${this.p.lvl}`,12,y);y+=20;c.fillText(`EXP:${~~this.p.exp}/${this.p.expReq}`,12,y);y+=20;c.fillText(`Wave:${this.wave}${this.boss?'âš ï¸':''}`,12,y);y+=20;c.fillText(`Rooms:${this.explored.size}/${this.map.rooms.length}`,12,y);y+=20;const m=~~(this.gt/60),s=~~(this.gt%60);c.fillText(`Time:${m}:${s.toString().padStart(2,'0')}`,12,y);y+=20;c.fillText(`K:${this.kills} G:${this.gold}`,12,y);this.map.drawMinimap(c,this.p.x,this.p.y,this.explored,this.currentRoom,this.save.settings.showMinimap);if(this.achPop){c.save();c.globalAlpha=Math.min(1,this.achPop.t/30);c.fillStyle='rgba(241,196,15,0.9)';c.fillRect(this.cv.width/2-130,60,260,55);c.fillStyle='#000';c.font='bold 18px monospace';c.textAlign='center';c.fillText('ğŸ†æˆå°±è§£é”!',this.cv.width/2,85);c.font='16px monospace';c.fillText(`${this.achPop.a.i} ${this.achPop.a.n}`,this.cv.width/2,105);c.restore()}if(this.upgrading){c.fillStyle='rgba(0,0,0,0.85)';c.fillRect(0,0,this.cv.width,this.cv.height);c.fillStyle='#F1C40F';c.font='bold 32px monospace';c.textAlign='center';c.fillText('å‡çº§é€‰æ‹©',this.cv.width/2,this.cv.height/2-90);c.font='14px monospace';c.fillText('æŒ‰æ•°å­—é”® 1-3 é€‰æ‹©',this.cv.width/2,this.cv.height/2-65);for(let i=0;i<this.upgs.length;i++){const u=this.upgs[i],uy=this.cv.height/2-30+i*55;c.fillStyle='#3498DB';c.fillRect(this.cv.width/2-120,uy-22,240,45);c.fillStyle='#FFF';c.font='bold 18px monospace';c.fillText(`${i+1}. ${u.n}`,this.cv.width/2,uy+5)}}if(this.paused){c.fillStyle='rgba(0,0,0,0.7)';c.fillRect(0,0,this.cv.width,this.cv.height);c.fillStyle='#FFF';c.font='bold 48px monospace';c.textAlign='center';c.fillText('PAUSED',this.cv.width/2,this.cv.height/2);c.font='16px monospace';c.fillText('ESC:ç»§ç»­ | M:å°åœ°å›¾ | P:ç²’å­æ•ˆæœ',this.cv.width/2,this.cv.height/2+40)}}end(){this.over=true;this.save.totalRuns++;this.save.totalKills+=this.kills;this.save.gold+=this.gold;this.save.stats.totalDamage+=this.run.dmg;this.save.stats.totalExp+=this.run.exp;this.save.stats.bossesKilled+=this.run.boss;this.save.stats.powerupsUsed+=this.run.pup;if(this.gt>this.save.bestTime)this.save.bestTime=this.gt;if(this.wave>this.save.bestWave)this.save.bestWave=this.wave;if(this.daily)this.save.dailyCompleted=true;SaveSystem.save(this.save);this.cx.fillStyle='rgba(0,0,0,0.9)';this.cx.fillRect(0,0,this.cv.width,this.cv.height);this.cx.fillStyle='#E74C3C';this.cx.font='bold 56px monospace';this.cx.textAlign='center';this.cx.fillText('GAME OVER',this.cv.width/2,this.cv.height/2-90);this.cx.fillStyle='#FFF';this.cx.font='24px monospace';this.cx.fillText(`Wave:${this.wave} Kills:${this.kills} Lv:${this.p.lvl}`,this.cv.width/2,this.cv.height/2-35);const m=~~(this.gt/60),s=~~(this.gt%60);this.cx.font='20px monospace';this.cx.fillText(`Time:${m}m${s}s Gold:${this.gold}`,this.cv.width/2,this.cv.height/2+5);this.cx.fillStyle='#3498DB';this.cx.fillText(`Dmg:${~~this.run.dmg} Exp:${~~this.run.exp}`,this.cv.width/2,this.cv.height/2+40);this.cx.fillStyle='#F1C40F';this.cx.fillText(`Total:${this.save.gold}`,this.cv.width/2,this.cv.height/2+75);this.cx.fillStyle='#AAA';this.cx.font='16px monospace';this.cx.fillText('Press SPACE for Menu',this.cv.width/2,this.cv.height/2+120);setTimeout(()=>window.addEventListener('keydown',e=>{if(e.code==='Space')showMenu()},{once:true}),500)}loop(){this.update();this.draw();requestAnimationFrame(this.loop)}}

// ========== èœå•ç³»ç»Ÿ (ä¿®å¤æ‰€æœ‰UIé—®é¢˜) ==========
function showMenu(){const s=SaveSystem.load(),today=new Date().toDateString();if(s.lastDaily!==today){s.dailyCompleted=false;s.lastDaily=today;SaveSystem.save(s)}const dm={n:'ä»Šæ—¥',d:'æ— å°½æŒ‘æˆ˜'},ac=Object.keys(s.achievements).length,tc=Object.keys(ACHIEVEMENTS).length;const md=document.createElement('div');md.id='menuScreen';md.innerHTML=`<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#2d1b2e;display:flex;flex-direction:column;align-items:center;color:white;z-index:9999;font-family:monospace;padding:12px;overflow-y:auto;"><h1 style="font-size:38px;margin:8px 0;">ğŸ„è‚‰é¸½ç‰›ç‰›</h1><p style="font-size:14px;color:#aaa;margin-bottom:8px;">v3.0 - å®Œæ•´ç‰ˆ | ğŸ†${ac}/${tc}</p><div style="background:linear-gradient(135deg,#8E44AD,#3498DB);padding:10px 20px;border-radius:10px;margin-bottom:12px;cursor:pointer;" onclick="startDaily()"><h3 style="margin:0;font-size:16px;">ğŸ†æ¯æ—¥æŒ‘æˆ˜</h3><p style="margin:2px 0;font-size:12px;">${dm.n}:${dm.d}</p><p style="margin:0;font-size:10px;color:#FFD700;">${s.dailyCompleted?'âœ…å·²å®Œæˆ':'âš¡å¯æŒ‘æˆ˜'}</p></div><div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;width:100%;max-width:1100px;"><div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;min-width:140px;"><h3 style="color:#F1C40F;margin:0 0 8px;font-size:16px;">ğŸ’°${s.gold}</h3><p style="margin:2px 0;font-size:11px;">æ€»å‡»æ€:${s.totalKills}</p><p style="margin:2px 0;font-size:11px;">æ€»å±€æ•°:${s.totalRuns}</p><p style="margin:2px 0;font-size:11px;">æœ€ä½³æ³¢æ¬¡:${s.bestWave}</p></div><div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;flex:1;min-width:200px;"><h3 style="color:#3498DB;margin:0 0 8px;font-size:16px;">âš”ï¸å‡çº§</h3>${rUpg(s,'damage','æ”»å‡»',100,'ğŸ—¡ï¸')}${rUpg(s,'hp','ç”Ÿå‘½',80,'â¤ï¸')}${rUpg(s,'speed','ç§»é€Ÿ',120,'ğŸ‘Ÿ')}${rUpg(s,'expGain','ç»éªŒ',150,'ğŸ’')}</div><div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;min-width:140px;"><h3 style="color:#E74C3C;margin:0 0 8px;font-size:16px;">ğŸ”«æ­¦å™¨</h3>${rWep('single','å•å‘',true)}${rWep('dual','åŒæª',s.gold>=200)}${rWep('shotgun','éœ°å¼¹',s.gold>=500)}${rWep('spread','ç¯å°„',s.gold>=800)}${rWep('rapid','é€Ÿå°„',s.gold>=1000)}${rWep('laser','æ¿€å…‰',s.gold>=1500)}</div><div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;min-width:140px;"><h3 style="color:#9B59B6;margin:0 0 8px;font-size:16px;">ğŸ“Šç»Ÿè®¡</h3><p style="margin:2px 0;font-size:10px;">æ€»ä¼¤å®³:${~~s.stats.totalDamage}</p><p style="margin:2px 0;font-size:10px;">æ€»ç»éªŒ:${~~s.stats.totalExp}</p><p style="margin:2px 0;font-size:10px;">BOSS:${s.stats.bossesKilled}</p><p style="margin:2px 0;font-size:10px;">é“å…·:${s.stats.powerupsUsed}</p><button onclick="showAch()" style="margin-top:8px;padding:5px 10px;background:#F1C40F;color:#000;border:none;border-radius:5px;cursor:pointer;font-size:10px;">æˆå°±(${ac}/${tc})</button></div><div style="background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;min-width:140px;"><h3 style="color:#1ABC9C;margin:0 0 8px;font-size:16px;">âš™ï¸è®¾ç½®</h3><p style="margin:2px 0;font-size:11px;">éŸ³é‡:${~~(s.settings.volume*100)}%</p><input type="range" min="0" max="100" value="${~~(s.settings.volume*100)}" onchange="Audio.vol=this.value/100" style="width:100%;"><p style="margin:6px 0 2px;font-size:10px;color:#aaa;">Mé”®:å°åœ°å›¾</p><p style="margin:2px 0;font-size:10px;color:#aaa;">Pé”®:ç²’å­æ•ˆæœ</p></div></div><button onclick="startNormal()" style="margin-top:12px;padding:10px 40px;font-size:20px;background:#E74C3C;color:white;border:none;border-radius:10px;cursor:pointer;">å¼€å§‹æ¸¸æˆ</button><p style="margin-top:10px;font-size:11px;color:#666;">WASDç§»åŠ¨ â€¢ è‡ªåŠ¨æ”»å‡» â€¢ ESCæš‚åœ</p></div>`;document.body.appendChild(md);let sw='single';document.querySelectorAll('.wep-btn').forEach(b=>{b.onclick=()=>{if(b.dataset.lk==='true')return;document.querySelectorAll('.wep-btn').forEach(x=>{x.style.borderColor='transparent';x.style.background='rgba(0,0,0,0.3)'});b.style.borderColor='#F1C40F';b.style.background='rgba(241,196,15,0.3)';sw=b.dataset.w}});window.startNormal=()=>{Audio.click();const ms=document.getElementById('menuScreen');if(ms)ms.remove();new Game(sw,false).loop()};window.startDaily=()=>{if(s.dailyCompleted){alert('ä»Šæ—¥å·²å®Œæˆ!');return}Audio.click();const ms=document.getElementById('menuScreen');if(ms)ms.remove();new Game('single',true).loop()};window.showAch=()=>{const ad=document.createElement('div');ad.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:20px;border-radius:15px;max-height:80vh;overflow-y:auto;z-index:10000;color:white;font-family:monospace;min-width:320px;';let h='<h2 style="text-align:center;margin:0 0 15px;">ğŸ†æˆå°±</h2>';for(let[id,a]of Object.entries(ACHIEVEMENTS)){const u=s.achievements[id];h+=`<div style="padding:8px;margin:4px 0;background:${u?'rgba(39,174,96,0.3)':'rgba(0,0,0,0.3)'};border-radius:5px;opacity:${u?1:0.5};"><span style="font-size:18px;margin-right:6px;">${a.i}</span><b style="font-size:14px;">${a.n}</b><br><small style="font-size:11px;">${a.d}</small>${u?'<span style="float:right;color:#27AE60;">âœ“</span>':''}</div>`}h+='<button onclick="this.parentElement.remove()" style="margin-top:10px;width:100%;padding:10px;background:#E74C3C;color:white;border:none;border-radius:5px;cursor:pointer;">å…³é—­</button>';ad.innerHTML=h;document.body.appendChild(ad)}}
function rUpg(s,t,n,bc,i){const l=s.permanent[t],mx={damage:10,hp:10,speed:5,expGain:10,critChance:5,armor:5}[t],c=bc+l*50,ca=s.gold>=c,im=l>=mx;return`<div style="display:flex;justify-content:space-between;align-items:center;margin:3px 0;padding:5px;background:rgba(0,0,0,0.3);border-radius:5px;font-size:11px;"><span>${i}${n}:${l}/${mx}</span><button onclick="bUpg('${t}')"${!ca||im?' disabled':''} style="padding:2px 8px;background:${im?'#666':ca?'#27AE60':'#666'};color:white;border:none;border-radius:3px;cursor:${im||!ca?'not-allowed':'pointer'};font-size:10px;">${im?'MAX':c+'ğŸ’°'}</button></div>`}
function rWep(id,n,u){return`<div class="wep-btn" data-w="${id}" data-lk="${!u}" style="padding:5px;margin:2px 0;background:${!u?'#333':id==='single'?'rgba(241,196,15,0.3)':'rgba(0,0,0,0.3)'};border-radius:5px;border:2px solid ${id==='single'?'#F1C40F':'transparent'};cursor:${!u?'not-allowed':'pointer'};opacity:${!u?0.5:1};font-size:11px;transition:all 0.2s;">${!u?'ğŸ”’':''}${n}</div>`}
function bUpg(t){const s=SaveSystem.load(),bc={damage:100,hp:80,speed:120,expGain:150,critChance:200,armor:100},c=bc[t]+s.permanent[t]*50,mx={damage:10,hp:10,speed:5,expGain:10,critChance:5,armor:5}[t];if(s.permanent[t]>=mx)return;if(s.gold>=c){s.gold-=c;s.permanent[t]++;SaveSystem.save(s);Audio.click();const ms=document.getElementById('menuScreen');if(ms)ms.remove();showMenu()}}
window.onload=()=>{showMenu();console.log('Rougelike Cow v3.0 FINAL - Ready')};if(typeof Audio==='undefined')window.Audio={vol:0.3,init(){} };
