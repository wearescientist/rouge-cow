// è‚‰é¸½ç‰›ç‰› v2.5 - Performance & Polish
const Utils={distance:(a,b)=>Math.hypot(a.x-b.x,a.y-b.y),clamp:(v,min,max)=>Math.max(min,Math.min(max,v))};

// ========== å­˜å‚¨ç³»ç»Ÿ ==========
const SaveSystem={
    KEY:'rogueCow_v25',
    load(){const d=localStorage.getItem(this.KEY);return d?JSON.parse(d):{gold:0,totalKills:0,totalRuns:0,bestTime:0,bestWave:0,bestLevel:0,permanent:{damage:0,hp:0,speed:0,expGain:0,critChance:0,armor:0},achievements:{},stats:{totalDamage:0,totalExp:0,bossesKilled:0,powerupsUsed:0},dailyCompleted:false,lastDaily:null,settings:{particles:true,screenShake:true,showDamage:true}}};
    save(d){localStorage.setItem(this.KEY,JSON.stringify(d))},
    unlock(id){const s=this.load();if(!s.achievements[id]){s.achievements[id]={date:Date.now()};this.save(s);return true}return false}
};

// ========== é…ç½®å¸¸é‡ ==========
const CONFIG={VERSION:'2.5.0',FPS:60,MAX_PARTICLES:200,MAX_ENEMIES:50,MAX_BULLETS:100};
const ACHIEVEMENTS={first_blood:{n:'ç¬¬ä¸€æ»´è¡€',d:'å‡»æ€ç¬¬ä¸€ä¸ªæ•Œäºº',i:'ğŸ©¸'},survivor:{n:'å¹¸å­˜è€…',d:'å­˜æ´»5åˆ†é’Ÿ',i:'â±ï¸'},wave_10:{n:'æ³¢æ¬¡å¤§å¸ˆ',d:'è¾¾åˆ°ç¬¬10æ³¢',i:'ğŸŒŠ'},boss_slayer:{n:'BOSSæ€æ‰‹',d:'å‡»è´¥BOSS',i:'ğŸ‘‘'},rich:{n:'å¯Œè±ª',d:'å•å±€1000é‡‘å¸',i:'ğŸ’°'},level_20:{n:'æ»¡çº§å¤§ä½¬',d:'è¾¾åˆ°20çº§',i:'â­'},killer_100:{n:'ç™¾äººæ–©',d:'ç´¯è®¡å‡»æ€100',i:'ğŸ’€'},killer_1000:{n:'åƒäººæ–©',d:'ç´¯è®¡å‡»æ€1000',i:'â˜ ï¸'}};
const POWERUPS={health:{c:'#E74C3C',i:'â¤ï¸',e:(p)=>p.hp=Math.min(p.maxHp+2,p.hp+5)},speed:{c:'#3498DB',i:'âš¡',e:(p)=>{p.speed*=1.5;setTimeout(()=>p.speed/=1.5,5e3)}},damage:{c:'#E67E22',i:'ğŸ’ª',e:(p)=>{p.damage*=2;setTimeout(()=>p.damage/=2,5e3)}},magnet:{c:'#9B59B6',i:'ğŸ§²',e:(p)=>{p.magnet=300;setTimeout(()=>p.magnet=0,8e3)}},shield:{c:'#F1C40F',i:'ğŸ›¡ï¸',e:(p)=>{p.shield=true;setTimeout(()=>p.shield=false,5e3)}},bomb:{c:'#C0392B',i:'ğŸ’£',e:(p,e,ps)=>e.forEach(en=>{en.hp-=10;ps.explode(en.x,en.y,'#C0392B',3)})}};

// ========== éŸ³é¢‘ ==========
const Audio={ctx:null,vol:0.3,init(){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new AudioContext()},resume(){this.ctx?.state==='suspended'&&this.ctx.resume()},play(f,d,t='square',v=0.1){if(!this.ctx)this.init();this.resume();const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.value=f;o.type=t;g.gain.setValueAtTime(v*this.vol,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+d);o.start();o.stop(this.ctx.currentTime+d)},shoot(){this.play(440,0.1)},hit(){this.play(200,0.15,'sawtooth')},explode(){this.play(150,0.3,'sawtooth')},level(){this.play(523,0.2);setTimeout(()=>this.play(659,0.2),100);setTimeout(()=>this.play(784,0.4),200)},click(){this.play(880,0.05)},boss(){this.play(150,0.3);setTimeout(()=>this.play(100,0.4),300)},power(){this.play(600,0.1);setTimeout(()=>this.play(800,0.15),100)},achieve(){this.play(523,0.1);setTimeout(()=>this.play(659,0.1),100);setTimeout(()=>this.play(784,0.1),200);setTimeout(()=>this.play(1047,0.3),300)}};

// ========== ç²’å­ç³»ç»Ÿ (ä¼˜åŒ–ç‰ˆ) ==========
class Particles{
    constructor(){this.pool=[];this.nums=[];this.shake=0;for(let i=0;i<CONFIG.MAX_PARTICLES;i++)this.pool.push({active:false})}
    explode(x,y,c='#FFF',n=10,f=4){if(this.pool.every(p=>p.active))return;let count=0;for(let p of this.pool){if(!p.active){p.active=true;p.x=x;p.y=y;const a=(Math.PI*2*count)/n;p.vx=Math.cos(a)*f;p.vy=Math.sin(a)*f;p.life=30;p.c=c;p.s=4;count++;if(count>=n)break}}this.shake=10}
    hit(x,y){for(let i=0;i<5;i++){const p=this.pool.find(p=>!p.active);if(p){p.active=true;p.x=x;p.y=y;p.vx=(Math.random()-0.5)*6;p.vy=(Math.random()-0.5)*6;p.life=20;p.c='#FFF';p.s=3}}}
    damage(x,y,d,crit){this.nums.push({x,y,t:crit?`CRIT ${~~d}!`:~~d,l:40,vy:-2,c:crit?'#FFD700':'#FFF',s:crit?24:16})}
    shakeScreen(ctx){if(this.shake>0){const dx=(Math.random()-0.5)*this.shake,dy=(Math.random()-0.5)*this.shake;ctx.translate(dx,dy);this.shake*=0.9;if(this.shake<0.5)this.shake=0;return()=>ctx.translate(-dx,-dy)}return null}
    update(){
        for(let p of this.pool){if(p.active){p.x+=p.vx;p.y+=p.vy;p.life--;p.s*=0.95;if(p.life<=0)p.active=false}}
        for(let i=this.nums.length-1;i>=0;i--){const d=this.nums[i];d.y+=d.vy;d.l--;if(d.l<=0)this.nums.splice(i,1)}
    }
    draw(ctx){for(let p of this.pool){if(p.active){ctx.globalAlpha=p.life/30;ctx.fillStyle=p.c;ctx.beginPath();ctx.arc(p.x,p.y,p.s,0,Math.PI*2);ctx.fill()}}ctx.globalAlpha=1;for(let d of this.nums){ctx.globalAlpha=d.l/40;ctx.fillStyle=d.c;ctx.font=`bold ${d.s}px monospace`;ctx.textAlign='center';ctx.fillText(d.t,d.x,d.y)}ctx.textAlign='left';ctx.globalAlpha=1}
}

// ========== å®ä½“ç±» ==========
class Entity{constructor(x,y,s,c){this.x=x;this.y=y;this.s=s;this.c=c;this.vx=0;this.vy=0;this.active=true}}
class Powerup extends Entity{constructor(x,y,t){const p=POWERUPS[t];super(x,y,30,p.c);this.t=t;this.i=p.i;this.bob=Math.random()*Math.PI*2}update(){this.bob+=0.1}draw(ctx){const b=Math.sin(this.bob)*5;ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y+b,this.s/2,0,Math.PI*2);ctx.fill();ctx.fillStyle='#FFF';ctx.font='20px monospace';ctx.textAlign='center';ctx.fillText(this.i,this.x,this.y+b+7);ctx.textAlign='left'}}
class Boss extends Entity{constructor(x,y,t='wolf'){super(x,y,100,'#8E44AD');this.t=t;this.mhp=t==='wolf'?100:150;this.hp=this.mhp;this.sp=1.5;this.ph=1;this.at=0;this.mt=0;this.tx=x;this.ty=y;this.f=-1}update(p,W,H){this.at++;this.mt++;if(this.hp<this.mhp*0.5)this.ph=2;if(this.hp<this.mhp*0.25)this.ph=3;if(this.mt%120===0){const a=Math.random()*Math.PI*2,d=200;this.tx=Utils.clamp(this.x+Math.cos(a)*d,100,W-100);this.ty=Utils.clamp(this.y+Math.sin(a)*d,100,H-100)}const dx=this.tx-this.x,dy=this.ty-this.y,d=Math.hypot(dx,dy);if(d>5){this.x+=(dx/d)*this.sp;this.y+=(dy/d)*this.sp}const pdx=p.x-this.x;this.f=pdx<0?-1:pdx>0?1:this.f}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.f===1)ctx.scale(-1,1);const pu=1+Math.sin(Date.now()/200)*0.1;ctx.fillStyle=this.ph===3?'#C0392B':this.ph===2?'#E74C3C':'#8E44AD';ctx.beginPath();ctx.arc(0,0,this.s/2*pu,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(-15,-15,12,0,Math.PI*2);ctx.arc(15,-15,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#E74C3C';ctx.beginPath();ctx.arc(-15+Math.sin(Date.now()/100)*2,-15,6,0,Math.PI*2);ctx.arc(15+Math.sin(Date.now()/100)*2,-15,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-this.s/2,-this.s/2-15,this.s,10);ctx.fillStyle=this.ph===3?'#C0392B':'#E74C3C';ctx.fillRect(-this.s/2+2,-this.s/2-13,(this.s-4)*(this.hp/this.mhp),6);ctx.fillStyle='#FFF';ctx.font='bold 20px monospace';ctx.textAlign='center';ctx.fillText(`BOSS HP: ${~~this.hp}/${this.mhp}`,0,-this.s/2-20);ctx.restore()}}
class Enemy extends Entity{constructor(x,y,t='pig'){const types={chick:{c:'#FFD700',hp:1,sp:2.8,exp:8,s:40,g:1},pig:{c:'#FF69B4',hp:3,sp:1.5,exp:12,s:50,g:2},sheep:{c:'#ECF0F1',hp:5,sp:1.2,exp:15,s:55,g:3},cow:{c:'#FFF',hp:8,sp:1,exp:20,s:60,g:5},bull:{c:'#C0392B',hp:15,sp:2,exp:30,s:65,g:8}};const tp=types[t]||types.pig;super(x,y,tp.s,tp.c);this.t=t;this.hp=tp.hp;this.mhp=tp.hp;this.sp=tp.sp;this.exp=tp.exp;this.g=tp.g;this.f=-1}update(p){const dx=p.x-this.x,dy=p.y-this.y,d=Math.hypot(dx,dy);if(d>0){this.x+=(dx/d)*this.sp;this.y+=(dy/d)*this.sp}this.f=dx<0?-1:dx>0?1:this.f}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.f===1)ctx.scale(-1,1);ctx.fillStyle=this.c;ctx.fillRect(-this.s/2,-this.s/2,this.s,this.s);ctx.fillStyle='#000';ctx.fillRect(-this.s/3,-this.s/4,this.s/6,this.s/6);ctx.fillRect(this.s/6,-this.s/4,this.s/6,this.s/6);if(this.hp<this.mhp){ctx.fillStyle='#000';ctx.fillRect(-this.s/2,-this.s/2-10,this.s,6);ctx.fillStyle='#E74C3C';ctx.fillRect(-this.s/2,-this.s/2-10,this.s*(this.hp/this.mhp),6)}ctx.restore()}}
class Bullet extends Entity{constructor(x,y,tx,ty,dmg,crit,sp=10){super(x,y,10,crit?'#FFD700':'#FFF');this.dmg=dmg;this.crit=crit;const a=Math.atan2(ty-y,tx-x);this.vx=Math.cos(a)*sp;this.vy=Math.sin(a)*sp}update(W,H){this.x+=this.vx;this.y+=this.vy;if(this.x<-50||this.x>W+50||this.y<-50||this.y>H+50)this.active=false}draw(ctx){ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(this.x,this.y,this.crit?8:6,0,Math.PI*2);ctx.fill();if(this.crit){ctx.strokeStyle='#FFD700';ctx.lineWidth=2;ctx.stroke()}}}
class Player extends Entity{constructor(x,y,perm={},w='single'){super(x,y,40,'#FFF');this.mhp=3+perm.hp;this.hp=this.mhp;this.bsp=5+perm.speed*0.3;this.sp=this.bsp;this.bdmg=1+perm.damage*0.5;this.dmg=this.bdmg;this.lvl=1;this.exp=0;this.expReq=100;this.cd=0;this.inv=0;this.f=1;this.crit=perm.critChance*0.05;this.critDmg=1.5;this.arm=perm.armor*0.5;this.expMul=1+perm.expGain*0.1;this.w=w;this.magnet=0;this.shield=false}update(inpt,en,W,H){let dx=0,dy=0;if(inpt.keys.w||inpt.keys.arrowup)dy=-1;if(inpt.keys.s||inpt.keys.arrowdown)dy=1;if(inpt.keys.a||inpt.keys.arrowleft){dx=-1;this.f=-1}if(inpt.keys.d||inpt.keys.arrowright){dx=1;this.f=1}if(dx!==0||dy!==0){const l=Math.hypot(dx,dy);this.x+=(dx/l)*this.sp;this.y+=(dy/l)*this.sp}this.x=Utils.clamp(this.x,this.s/2,W-this.s/2);this.y=Utils.clamp(this.y,this.s/2,H-this.s/2);if(this.inv>0)this.inv--;if(this.cd>0)this.cd--;if(this.cd<=0)return this.findTarget(en);return null}findTarget(en){let near=null,minD=300;for(let e of en){const d=Utils.distance(this,e);if(d<minD){minD=d;near=e}}return near}shoot(t,bs){if(!t)return;const crit=Math.random()<this.crit;const cds={single:20,dual:15,shotgun:35,spread:25,rapid:8,laser:40};switch(this.w){case'single':bs.push(new Bullet(this.x,this.y,t.x,t.y,this.dmg,crit));break;case'dual':bs.push(new Bullet(this.x-10,this.y,t.x,t.y,this.dmg*0.8,crit));bs.push(new Bullet(this.x+10,this.y,t.x,t.y,this.dmg*0.8,crit));break;case'shotgun':for(let i=-2;i<=2;i++){const a=Math.atan2(t.y-this.y,t.x-this.x)+i*0.2;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.6,crit))}break;case'spread':for(let i=0;i<8;i++){const a=(Math.PI*2*i)/8;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.5,crit))}break;case'rapid':const sp=(Math.random()-0.5)*0.3,a=Math.atan2(t.y-this.y,t.x-this.x)+sp;bs.push(new Bullet(this.x,this.y,this.x+Math.cos(a)*300,this.y+Math.sin(a)*300,this.dmg*0.7,crit,12));break;case'laser':bs.push(new Bullet(this.x,this.y,t.x,t.y,this.dmg*3,crit,15))}this.cd=cds[this.w]||20;Audio.shoot()}gainExp(a,ps){const fa=a*this.expMul;this.exp+=fa;if(this.exp>=this.expReq){this.exp-=this.expReq;this.lvl++;this.expReq=~~(this.expReq*1.2);this.hp=Math.min(this.mhp+1,this.hp+1);Audio.level();if(ps)ps.explode(this.x,this.y,'#FFD700',20);return true}return false}takeDamage(dmg){if(this.shield||this.inv>0)return false;const ad=Math.max(1,dmg-this.arm);this.hp-=ad;this.inv=60;Audio.hit();return this.hp<=0}draw(ctx){ctx.save();ctx.translate(this.x,this.y);if(this.inv>0&&~~(Date.now()/50)%2)ctx.globalAlpha=0.5;if(this.f===-1)ctx.scale(-1,1);if(this.shield){ctx.strokeStyle='#F1C40F';ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,35,0,Math.PI*2);ctx.stroke()}ctx.fillStyle='#FFE4C4';ctx.fillRect(-20,-30,40,60);ctx.fillStyle='#FFF';ctx.beginPath();ctx.arc(0,-25,20,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.fillRect(-8,-28,4,4);ctx.fillRect(4,-28,4,4);ctx.restore()}}

// ========== æ¸¸æˆä¸»ç±» ==========
class Game{constructor(w='single',daily=false){this.cv=document.getElementById('gameCanvas');this.cx=this.cv.getContext('2d');this.resize();window.addEventListener('resize',()=>this.resize());this.save=SaveSystem.load();this.p=new Player(this.cv.width/2,this.cv.height/2,this.save.permanent,w);this.en=[];this.bs=[];this.ps=new Particles();this.pups=[];this.wave=1;this.wt=0;this.gt=0;this.kills=0;this.gold=0;this.boss=null;this.over=false;this.paused=false;this.upgrading=false;this.upgs=[];this.daily=daily;this.mod=daily?DailyChallenge.getModifiers():null;this.run={dmg:0,exp:0,boss:0,pup:0};this.newAch=[];this.inp={keys:{}};window.addEventListener('keydown',e=>{this.inp.keys[e.key.toLowerCase()]=true;if(e.key==='Escape')this.togglePause();if(e.key>='1'&&e.key<='3'&&this.upgrading)this.pickUpg(parseInt(e.key)-1)});window.addEventListener('keyup',e=>this.inp.keys[e.key.toLowerCase()]=false);this.loop=this.loop.bind(this)}resize(){this.cv.width=window.innerWidth;this.cv.height=window.innerHeight}togglePause(){if(!this.over&&!this.upgrading)this.paused=!this.paused}
    
    checkAch(){const checks=[{id:'first_blood',c:this.kills>=1},{id:'survivor',c:this.gt>=300},{id:'wave_10',c:this.wave>=10},{id:'boss_slayer',c:this.run.boss>=1},{id:'rich',c:this.gold>=1000},{id:'level_20',c:this.p.lvl>=20},{id:'killer_100',c:this.save.totalKills+this.kills>=100},{id:'killer_1000',c:this.save.totalKills+this.kills>=1000}];checks.forEach(ch=>{if(ch.c&&SaveSystem.unlock(ch.id)){this.newAch.push(ACHIEVEMENTS[ch.id]);Audio.achieve()}})}
    
    spawnEn(){let x,y;if(Math.random()<0.5){x=Math.random()<0.5?-50:this.cv.width+50;y=Math.random()*this.cv.height}else{x=Math.random()*this.cv.width;y=Math.random()<0.5?-50:this.cv.height+50}const types=['chick','pig'];if(this.wave>2)types.push('sheep');if(this.wave>4)types.push('cow');if(this.wave>6)types.push('bull');const t=types[~~(Math.random()*types.length)];const e=new Enemy(x,y,t);if(this.mod)this.mod.apply(e);this.en.push(e)}
    spawnPup(x,y){if(Math.random()>0.15)return;const types=Object.keys(POWERUPS);this.pups.push(new Powerup(x,y,types[~~(Math.random()*types.length)]))}
    spawnBoss(){this.boss=new Boss(this.cv.width/2,-100);Audio.boss()}
    pickUpg(i){if(i>=0&&i<this.upgs.length){this.applyUpg(this.upgs[i]);this.upgrading=false;this.upgs=[]}}
    genUpgs(){const all=[{n:'ä¼¤å®³æå‡',d:'æ”»å‡»åŠ›+0.5',a:()=>this.p.dmg+=0.5},{n:'ç”Ÿå‘½å¼ºåŒ–',d:'æœ€å¤§ç”Ÿå‘½+1',a:()=>{this.p.mhp++;this.p.hp++}},{n:'æé€Ÿç§»åŠ¨',d:'ç§»é€Ÿ+0.5',a:()=>this.p.sp+=0.5},{n:'æš´å‡»è®­ç»ƒ',d:'æš´å‡»ç‡+5%',a:()=>this.p.crit+=0.05},{n:'æŠ¤ç”²åŠ å›º',d:'æŠ¤ç”²+0.5',a:()=>this.p.arm+=0.5},{n:'ç»éªŒå¢å¹…',d:'ç»éªŒè·å–+10%',a:()=>this.p.expMul+=0.1}];return all.sort(()=>0.5-Math.random()).slice(0,3)}
    applyUpg(u){u.a();Audio.level()}
    
    update(){if(this.paused||this.over||this.upgrading){if(this.achPop&&this.achPop.t>0)this.achPop.t--;return}this.gt+=1/60;this.wt++;this.checkAch();if(this.achPop){this.achPop.t--;if(this.achPop.t<=0){this.achPop=null;if(this.newAch.length>0){const a=this.newAch.shift();this.achPop={a,t:180}}}}
        const sr=this.boss?60:Math.max(30,120-this.wave*3);if(this.wt%sr===0&&this.en.length<(this.boss?5:Math.min(CONFIG.MAX_ENEMIES,15+this.wave*2)))this.spawnEn();if(!this.boss&&this.wave%5===0&&this.wt===600)this.spawnBoss();if(!this.boss&&this.wt%1800===0)this.wave++;
        const targets=this.boss?[this.boss,...this.en]:this.en;const t=this.p.update(this.inp,targets,this.cv.width,this.cv.height);if(t)this.p.shoot(t,this.bs);
        for(let p of this.pups)p.update();for(let i=this.pups.length-1;i>=0;i--){const p=this.pups[i],d=Utils.distance(this.p,p);if(d<this.p.s/2+p.s/2||(this.p.magnet>0&&d<this.p.magnet)){POWERUPS[p.t].e(this.p,this.en,this.ps);if(p.t==='bomb'){for(let j=this.en.length-1;j>=0;j--){if(this.en[j].hp<=0){this.p.gainExp(this.en[j].exp,this.ps);this.gold+=this.en[j].g;this.kills++}}this.en=this.en.filter(e=>e.hp>0)}this.run.pup++;Audio.power();this.pups.splice(i,1)}}
        for(let i=this.bs.length-1;i>=0;i--){const b=this.bs[i];b.update(this.cv.width,this.cv.height);if(!b.active){this.bs.splice(i,1);continue}if(this.boss&&Utils.distance(b,this.boss)<this.boss.s/2+10){b.active=false;this.boss.hp-=b.dmg;this.run.dmg+=b.dmg;this.ps.damage(this.boss.x,this.boss.y-50,b.dmg,b.crit);if(this.boss.hp<=0){this.ps.explode(this.boss.x,this.boss.y,'#8E44AD',50,8);this.p.gainExp(200,this.ps);this.gold+=50;this.spawnPup(this.boss.x,this.boss.y);this.run.boss++;this.run.exp+=200;this.boss=null;this.wave++;Audio.explode()}}
            for(let j=this.en.length-1;j>=0;j--){const e=this.en[j];if(Utils.distance(b,e)<e.s/2+10){b.active=false;e.hp-=b.dmg;this.run.dmg+=b.dmg;this.ps.damage(e.x,e.y-20,b.dmg,b.crit);this.ps.hit(e.x,e.y);if(e.hp<=0){this.en.splice(j,1);const leveled=this.p.gainExp(e.exp,this.ps);this.run.exp+=e.exp;this.gold+=e.g;this.spawnPup(e.x,e.y);this.ps.explode(e.x,e.y,e.c,10);Audio.explode();this.kills++;if(leveled){this.upgrading=true;this.upgs=this.genUpgs()}}break}}}
        if(this.boss){this.boss.update(this.p,this.cv.width,this.cv.height);if(Utils.distance(this.boss,this.p)<this.boss.s/2+30)if(this.p.takeDamage(2)){this.end();return}}
        for(let i=this.en.length-1;i>=0;i--){const e=this.en[i];e.update(this.p);e.x=Utils.clamp(e.x,-100,this.cv.width+100);e.y=Utils.clamp(e.y,-100,this.cv.height+100);if(Utils.distance(e,this.p)<e.s/2+20)if(this.p.takeDamage(1)){this.end();return}}this.ps.update()}
    
    draw(){const sr=this.ps.shakeScreen(this.cx);this.cx.fillStyle='#2d1b2e';this.cx.fillRect(0,0,this.cv.width,this.cv.height);this.cx.strokeStyle='#3d2b3e';this.cx.lineWidth=1;for(let x=0;x<this.cv.width;x+=80){this.cx.beginPath();this.cx.moveTo(x,0);this.cx.lineTo(x,this.cv.height);this.cx.stroke()}for(let y=0;y<this.cv.height;y+=80){this.cx.beginPath();this.cx.moveTo(0,y);this.cx.lineTo(this.cv.width,y);this.cx.stroke()}this.ps.draw(this.cx);for(let p of this.pups)p.draw(this.cx);for(let b of this.bs)b.draw(this.cx);if(this.boss)this.boss.draw(this.cx);for(let e of this.en)e.draw(this.cx);this.p.draw(this.cx);if(sr)sr();this.drawUI()}
    drawUI(){const c=this.cx;c.fillStyle='#FFF';c.font='18px monospace';c.textAlign='left';let y=35;c.fillText(`HP:${'â¤ï¸'.repeat(Math.max(0,this.p.hp))}${'ğŸ–¤'.repeat(Math.max(0,this.p.mhp-this.p.hp))}`,15,y);y+=25;c.fillText(`Lv:${this.p.lvl}`,15,y);y+=25;c.fillText(`EXP:${~~this.p.exp}/${this.p.expReq}`,15,y);y+=25;c.fillText(`Wave:${this.wave}${this.boss?'âš ï¸BOSS':''}`,15,y);y+=25;const m=~~(this.gt/60),s=~~(this.gt%60);c.fillText(`Time:${m}:${s.toString().padStart(2,'0')}`,15,y);y+=25;c.fillText(`Kills:${this.kills} Gold:${this.gold}`,15,y);
        if(this.achPop){c.save();c.globalAlpha=Math.min(1,this.achPop.t/30);c.fillStyle='rgba(241,196,15,0.9)';c.fillRect(this.cv.width/2-150,80,300,70);c.fillStyle='#000';c.font='bold 22px monospace';c.textAlign='center';c.fillText('ğŸ†æˆå°±è§£é”!',this.cv.width/2,115);c.fillText(`${this.achPop.a.i} ${this.achPop.a.n}`,this.cv.width/2,140);c.restore()}
        if(this.upgrading){c.fillStyle='rgba(0,0,0,0.85)';c.fillRect(0,0,this.cv.width,this.cv.height);c.fillStyle='#F1C40F';c.font='bold 36px monospace';c.textAlign='center';c.fillText('å‡çº§é€‰æ‹©',this.cv.width/2,this.cv.height/2-100);for(let i=0;i<this.upgs.length;i++){const u=this.upgs[i],uy=this.cv.height/2-20+i*60;c.fillStyle='#3498DB';c.fillRect(this.cv.width/2-150,uy-25,300,50);c.fillStyle='#FFF';c.font='bold 20px monospace';c.fillText(`${i+1}.${u.n}`,this.cv.width/2,uy);c.font='14px monospace';c.fillStyle='#CCC';c.fillText(u.d,this.cv.width/2,uy+18)}}
        if(this.paused){c.fillStyle='rgba(0,0,0,0.7)';c.fillRect(0,0,this.cv.width,this.cv.height);c.fillStyle='#FFF';c.font='bold 48px monospace';c.textAlign='center';c.fillText('PAUSED',this.cv.width/2,this.cv.height/2)}}
    end(){this.over=true;this.save.totalRuns++;this.save.totalKills+=this.kills;this.save.gold+=this.gold;this.save.stats.totalDamage+=this.run.dmg;this.save.stats.totalExp+=this.run.exp;this.save.stats.bossesKilled+=this.run.boss;this.save.stats.powerupsUsed+=this.run.pup;if(this.gt>this.save.bestTime)this.save.bestTime=this.gt;if(this.wave>this.save.bestWave)this.save.bestWave=this.wave;if(this.daily)this.save.dailyCompleted=true;SaveSystem.save(this.save);this.cx.fillStyle='rgba(0,0,0,0.9)';this.cx.fillRect(0,0,this.cv.width,this.cv.height);this.cx.fillStyle='#E74C3C';this.cx.font='bold 64px monospace';this.cx.textAlign='center';this.cx.fillText('GAME OVER',this.cv.width/2,this.cv.height/2-100);this.cx.fillStyle='#FFF';this.cx.font='28px monospace';this.cx.fillText(`Wave:${this.wave} Kills:${this.kills} Lv:${this.p.lvl}`,this.cv.width/2,this.cv.height/2-40);const m=~~(this.gt/60),s=~~(this.gt%60);this.cx.font='24px monospace';this.cx.fillText(`Time:${m}m${s}s Gold:${this.gold}`,this.cv.width/2,this.cv.height/2+10);this.cx.fillStyle='#3498DB';this.cx.fillText(`Dmg:${~~this.run.dmg} Exp:${~~this.run.exp}`,this.cv.width/2,this.cv.height/2+50);this.cx.fillStyle='#F1C40F';this.cx.fillText(`Total:${this.save.gold}`,this.cv.width/2,this.cv.height/2+90);this.cx.fillStyle='#AAA';this.cx.font='18px monospace';this.cx.fillText('Press SPACE',this.cv.width/2,this.cv.height/2+140);setTimeout(()=>window.addEventListener('keydown',e=>{if(e.code==='Space')showMenu()}, {once:true}),500)}
    loop(){this.update();this.draw();requestAnimationFrame(this.loop)}}

// ========== èœå• ==========
function showMenu(){const s=SaveSystem.load(),today=new Date().toDateString();if(s.lastDaily!==today){s.dailyCompleted=false;s.lastDaily=today;SaveSystem.save(s)}const dm=DailyChallenge.getModifiers(),ac=Object.keys(s.achievements).length,tc=Object.keys(ACHIEVEMENTS).length;const md=document.createElement('div');md.id='menuScreen';md.innerHTML=`<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:#2d1b2e;display:flex;flex-direction:column;align-items:center;color:white;z-index:9999;font-family:monospace;padding:15px;overflow-y:auto;"><h1 style="font-size:42px;margin:10px 0;">ğŸ„è‚‰é¸½ç‰›ç‰›</h1><p style="font-size:16px;color:#aaa;margin-bottom:10px;">v2.5 - æ€§èƒ½ä¼˜åŒ– | ğŸ†${ac}/${tc}</p><div style="background:linear-gradient(135deg,#8E44AD,#3498DB);padding:12px 25px;border-radius:10px;margin-bottom:15px;cursor:pointer;" onclick="startDaily()"><h3 style="margin:0;">ğŸ†æ¯æ—¥æŒ‘æˆ˜</h3><p style="margin:3px 0;font-size:13px;">${dm.n}:${dm.d}</p><p style="margin:0;font-size:11px;color:#FFD700;">${s.dailyCompleted?'âœ…å·²å®Œæˆ':'âš¡å¯æŒ‘æˆ˜'}</p></div><div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;width:100%;max-width:1200px;"><div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;min-width:160px;"><h3 style="color:#F1C40F;margin:0 0 10px;">ğŸ’°${s.gold}</h3><p style="margin:3px 0;font-size:12px;">æ€»å‡»æ€:${s.totalKills}</p><p style="margin:3px 0;font-size:12px;">æ€»å±€æ•°:${s.totalRuns}</p><p style="margin:3px 0;font-size:12px;">æœ€ä½³æ³¢æ¬¡:${s.bestWave}</p></div><div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;flex:1;min-width:220px;"><h3 style="color:#3498DB;margin:0 0 10px;">âš”ï¸å‡çº§</h3>${rUpg(s,'damage','æ”»å‡»åŠ›',100,'ğŸ—¡ï¸')}${rUpg(s,'hp','ç”Ÿå‘½',80,'â¤ï¸')}${rUpg(s,'speed','ç§»é€Ÿ',120,'ğŸ‘Ÿ')}${rUpg(s,'expGain','ç»éªŒ',150,'ğŸ’')}</div><div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;min-width:160px;"><h3 style="color:#E74C3C;margin:0 0 10px;">ğŸ”«æ­¦å™¨</h3>${rWep('single','å•å‘',true)}${rWep('dual','åŒæª',s.gold>=200)}${rWep('shotgun','éœ°å¼¹',s.gold>=500)}${rWep('spread','ç¯å°„',s.gold>=800)}${rWep('rapid','é€Ÿå°„',s.gold>=1000)}${rWep('laser','æ¿€å…‰',s.gold>=1500)}</div><div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;min-width:160px;"><h3 style="color:#9B59B6;margin:0 0 10px;">ğŸ“Šç»Ÿè®¡</h3><p style="margin:3px 0;font-size:11px;">æ€»ä¼¤å®³:${~~s.stats.totalDamage}</p><p style="margin:3px 0;font-size:11px;">æ€»ç»éªŒ:${~~s.stats.totalExp}</p><p style="margin:3px 0;font-size:11px;">å‡»è´¥BOSS:${s.stats.bossesKilled}</p><p style="margin:3px 0;font-size:11px;">ä½¿ç”¨é“å…·:${s.stats.powerupsUsed}</p><button onclick="showAch()" style="margin-top:10px;padding:6px 12px;background:#F1C40F;color:#000;border:none;border-radius:5px;cursor:pointer;font-size:11px;">æˆå°±(${ac}/${tc})</button></div></div><button onclick="startNormal()" style="margin-top:15px;padding:12px 50px;font-size:24px;background:#E74C3C;color:white;border:none;border-radius:10px;cursor:pointer;">å¼€å§‹æ¸¸æˆ</button></div>`;document.body.appendChild(md);let sw='single';document.querySelectorAll('.wep-btn').forEach(b=>{b.onclick=()=>{if(b.dataset.lk==='true')return;document.querySelectorAll('.wep-btn').forEach(x=>x.style.borderColor='transparent');b.style.borderColor='#F1C40F';sw=b.dataset.w}});window.startNormal=()=>{Audio.click();document.getElementById('menuScreen').remove();new Game(sw,false).loop()};window.startDaily=()=>{if(s.dailyCompleted){alert('ä»Šæ—¥å·²å®Œæˆ!');return}Audio.click();document.getElementById('menuScreen').remove();new Game('single',true).loop()};window.showAch=()=>{const ad=document.createElement('div');ad.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;padding:20px;border-radius:15px;max-height:80vh;overflow-y:auto;z-index:10000;color:white;font-family:monospace;min-width:350px;';let h='<h2 style="text-align:center;">ğŸ†æˆå°±</h2>';for(let[id,a]of Object.entries(ACHIEVEMENTS)){const u=s.achievements[id];h+=`<div style="padding:10px;margin:5px 0;background:${u?'rgba(39,174,96,0.3)':'rgba(0,0,0,0.3)'};border-radius:5px;opacity:${u?1:0.5};"><span style="font-size:20px;margin-right:8px;">${a.i}</span><b>${a.n}</b><br><small>${a.d}</small>${u?'<span style="float:right;color:#27AE60;">âœ“</span>':''}</div>`}h+='<button onclick="this.parentElement.remove()" style="margin-top:10px;width:100%;padding:10px;background:#E74C3C;color:white;border:none;border-radius:5px;cursor:pointer;">å…³é—­</button>';ad.innerHTML=h;document.body.appendChild(ad)}}
function rUpg(s,t,n,bc,i){const l=s.permanent[t],mx={damage:10,hp:10,speed:5,expGain:10,critChance:5,armor:5}[t],c=bc+l*50,ca=s.gold>=c,im=l>=mx;return`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;padding:6px;background:rgba(0,0,0,0.3);border-radius:5px;font-size:12px;"><span>${i}${n}:${l}/${mx}</span><button onclick="bUpg('${t}')"${!ca||im?' disabled':''} style="padding:3px 10px;background:${im?'#666':ca?'#27AE60':'#666'};color:white;border:none;border-radius:3px;cursor:${im||!ca?'not-allowed':'pointer'};font-size:11px;">${im?'MAX':c+'ğŸ’°'}</button></div>`}
function rWep(id,n,u){return`<div class="wep-btn" data-w="${id}" data-lk="${!u}" style="padding:6px;margin:3px 0;background:${!u?'#333':'rgba(0,0,0,0.3)'};border-radius:5px;border:2px solid ${id==='single'?'#F1C40F':'transparent'};cursor:${!u?'not-allowed':'pointer'};opacity:${!u?0.5:1};font-size:12px;">${!u?'ğŸ”’':''}${n}</div>`}
function bUpg(t){const s=SaveSystem.load(),c={damage:100,hp:80,speed:120,expGain:150,critChance:200,armor:100}[t]+s.permanent[t]*50,mx={damage:10,hp:10,speed:5,expGain:10,critChance:5,armor:5}[t];if(s.permanent[t]>=mx)return;if(s.gold>=c){s.gold-=c;s.permanent[t]++;SaveSystem.save(s);Audio.click();document.getElementById('menuScreen').remove();showMenu()}}
window.onload=showMenu;console.log('Rougelike Cow v2.5 - Performance Optimized');
